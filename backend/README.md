# バックエンド

## アーキテクチャ概要

バックエンドのアーキテクチャとしては、以下のアーキテクチャを利用します。

- レイヤ化アーキテクチャ
- イベンド駆動アーキテクチャ

### レイヤ化アーキテクチャ

責務を分割して依存方向をコントロールするため、全体を以下のレイヤーに分割します。

|レイヤ|責務|
| ------- | ------- |
| プレゼンテーション層 | ユーザーとの入出力をアプリケーションと接続する |
| アプリケーション層 | ドメインモデルを組み立ててアプリケーション機能を実現する |
| ドメイン層 | ドメインモデルでビジネスロジックを表現する |
| インフラストラクチャ層 | データの永続化や外部サービス接続等、特定リソースに依存した処理を実装する |

レイヤー間の依存方向をコントロールすることで、変更による影響範囲を最小限にし、保守性を高くします。
また、下位層であればどのレイヤーにも依存を許容する緩やかなレイヤ化とします。
インフラストラクチャ層については、依存関係逆転の原則を適用し、上位のレイヤーと位置づけます。

なお、Nablachの拡張実装等のフレームワーク固有の実装については、レイヤ化の対象外とします。
ここには容易にコンポーネント登録するためのアノテーション等、Nablarch利用を補助するための仕組みが含まれますが、
実装コストと影響範囲のトレードオフから、例外的にどのレイヤからでも依存を許容するものとします。

### イベント駆動アーキテクチャ

処理が完了した際のユーザーへの通知等、処理の完了を起点に別の処理を行う部分には、イベント駆動アーキテクチャを利用します。

イベントに対応するリスナを登録しておき、処理が完了した際にイベントを発行することで、複数の処理を行うためのパイプラインを形成します。
処理の追加や削除等の変更が発生した場合にでも、容易に拡張を可能にしておきます。

## クラス設計

以下の分類によって、クラスを設計します。

|レイヤ|分類|責務|
| ------- | ------- | ------- |
| プレゼンテーション層 | アクション | REST APIのエンドポイントを定義する。APIの入出力を変換し、アプリケーション層のサービスを呼ぶ。 |
|  | WebSocketサーバ | WebSocketサーバのエンドポイントを定義する。WebSocketによる通信を制御する。 |
| アプリケーション層 | サービス | ドメイン層のオブジェクトを利用し、アプリケーション機能を実現する。 |
|  | イベントリスナ | イベントにより起動する処理を定義する。同階層のサービスと同じ。 |
| ドメイン層 | ドメインモデル（エンティティ） | 「アカウント」「チャンネル」等、同一性を意識する単位を型で表現する。 |
|  | ドメインモデル（バリューオブジェクト） | 「ユーザー名」「メールアドレス」等、値を型で表現する。 |
|  | イベント | 処理の起点となるイベントを表現する。イベントに応じた処理を行うための情報を格納する。 |
|  | リポジトリ | インフラストラクチャ層の永続化実装に対するセパレートインターフェース |
| インフラストラクチャ層 | リポジトリ実装 | 永続化先のリソースに対する永続化処理を実装する。 |
|  | サービス | システム外のサービスに依存する連携処理を実装する。 |
| その他 | Nablarch拡張 | Nablarchの標準機能で不足している機能を実装する |

## パッケージ設計

トップレベルはレイヤ単位とし、分類別に分割します。必要に応じて、更に機能単位に分割します。

レイヤ外として扱うNablarch拡張実装については、別パッケージとします。

- presentation/ ... プレゼンテーション層
    - resetapi/ ... アクション
    - websocket/ ... WebSocketサーバ
- application/ ... アプリケーション層
    - service/ ... サービス
    - event/ ... イベントリスナ
- domain/ ... ドメイン層
    - model/ ... ドメインモデル
    - event/ ... イベント
    - repository/ ... リポジトリ
- infrastructure/ ... インフラストラクチャ層
    - persistence/ ... リポジトリ実装
    - service/ ... 外部サービス接続
- system/ ... その他
    - nablarch/ ... Nablarch拡張実装
